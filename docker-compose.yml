services:
  victim:
    image: alpine:latest
    container_name: victim
    hostname: victim
    networks:
      - labnet
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        apk add --no-cache python3 curl iputils busybox-extras netcat-openbsd wget &&
        echo '<h1>Welcome to victim HTTP server!</h1>' > /tmp/index.html &&
        python3 -m http.server 80 --bind 0.0.0.0 &
        while true; do sleep 3600; done
      "
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 10s
      timeout: 5s
      retries: 3

  attacker:
    image: kalilinux/kali-rolling:latest
    container_name: attacker
    hostname: attacker
    networks:
      - labnet
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        apt-get update -qq &&
        apt-get install -y -qq iputils-ping curl netcat-openbsd nmap wget tcpdump &&
        tail -f /dev/null
      "

  evebox:
    image: jasonish/evebox:latest
    container_name: evebox
    hostname: evebox
    networks:
      - labnet
    ports:
      - "5636:5636"
    volumes:
      - /var/log/suricata:/var/log/suricata:ro
    environment:
      - EVEBOX_ELASTICSEARCH_ENABLED=false
      - EVEBOX_ELASTICSEARCH_URL=
      - EVEBOX_DATABASE_TYPE=sqlite
      - EVEBOX_DATABASE_NAME=/var/log/suricata/evebox.db
      - EVEBOX_EVE_LOG_DIR=/var/log/suricata
      - EVEBOX_EVE_LOG_PATTERN=eve.json
    command: >
      sh -c "
        evebox --no-version-check --database sqlite --sqlite-file /var/log/suricata/evebox.db --datastore sqlite --input /var/log/suricata/eve.json --host 0.0.0.0 --port 5636
      "
    restart: unless-stopped
      
networks:
  labnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
